import { coerceElement } from '@angular/cdk/coercion';
import { isPlatformBrowser } from '@angular/common';
import { DestroyRef, effect, inject, INJECTOR, isSignal, PLATFORM_ID, signal, } from '@angular/core';
import { WA_WINDOW } from '@ng-web-apis/common';
import { TUI_ALLOW_SIGNAL_WRITES } from '@taiga-ui/cdk/constants';
export function tuiValue(input, injector = inject(INJECTOR)) {
    const win = injector.get(WA_WINDOW);
    if (!win.tuiInputPatched && isPlatformBrowser(injector.get(PLATFORM_ID))) {
        win.tuiInputPatched = true;
        patch(win.HTMLInputElement.prototype);
        patch(win.HTMLTextAreaElement.prototype);
        patch(win.HTMLSelectElement.prototype);
    }
    let element = isSignal(input) ? undefined : coerceElement(input);
    let cleanup = () => { };
    const options = { injector, ...TUI_ALLOW_SIGNAL_WRITES };
    const value = signal(element?.value || '');
    const process = (el) => {
        const update = () => value.set(el.value);
        el.addEventListener('input', update);
        el.addEventListener('tui-input', update);
        return () => {
            el.removeEventListener('input', update);
            el.removeEventListener('tui-input', update);
        };
    };
    injector.get(DestroyRef).onDestroy(() => cleanup());
    if (isSignal(input)) {
        effect(() => {
            element = coerceElement(input());
            cleanup();
            if (element) {
                value.set(element.value);
                cleanup = process(element);
            }
        }, options);
    }
    else if (element) {
        cleanup = process(element);
    }
    effect(() => {
        const v = value();
        if (element?.matches(':focus') && 'selectionStart' in element) {
            const { selectionStart, selectionEnd } = element;
            /**
             * After programmatic updates of input's value, caret is automatically placed at the end â€“
             * revert to the previous position
             */
            element.value = v;
            element.setSelectionRange(selectionStart, selectionEnd);
        }
        else if (element) {
            element.value = v;
        }
    }, options);
    return value;
}
function patch(prototype) {
    const { set } = Object.getOwnPropertyDescriptor(prototype, 'value');
    Object.defineProperty(prototype, 'value', {
        set(detail) {
            const value = this.value;
            const event = new CustomEvent('tui-input', { detail, bubbles: true });
            set.call(this, detail);
            if (value !== detail) {
                this.dispatchEvent(event);
            }
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsdWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jZGsvdXRpbHMvZG9tL3ZhbHVlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUNwRCxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUVsRCxPQUFPLEVBQ0gsVUFBVSxFQUNWLE1BQU0sRUFDTixNQUFNLEVBQ04sUUFBUSxFQUNSLFFBQVEsRUFDUixXQUFXLEVBQ1gsTUFBTSxHQUNULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUMsdUJBQXVCLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUloRSxNQUFNLFVBQVUsUUFBUSxDQUNwQixLQUllLEVBQ2YsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFFM0IsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBTSxTQUFTLENBQUMsQ0FBQztJQUV6QyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUU7UUFDdEUsR0FBRyxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFFM0IsS0FBSyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0QyxLQUFLLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pDLEtBQUssQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDMUM7SUFFRCxJQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsYUFBYSxD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QUFFO2dCQUNsQixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQzdCO1FBQ0wsQ0FBQztLQUNKLENBQUMsQ0FBQztBQUNQLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2NvZXJjZUVsZW1lbnR9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQge2lzUGxhdGZvcm1Ccm93c2VyfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHR5cGUge0VsZW1lbnRSZWYsIFNpZ25hbCwgV3JpdGFibGVTaWduYWx9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBEZXN0cm95UmVmLFxuICAgIGVmZmVjdCxcbiAgICBpbmplY3QsXG4gICAgSU5KRUNUT1IsXG4gICAgaXNTaWduYWwsXG4gICAgUExBVEZPUk1fSUQsXG4gICAgc2lnbmFsLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7V0FfV0lORE9XfSBmcm9tICdAbmctd2ViLWFwaXMvY29tbW9uJztcbmltcG9ydCB7VFVJX0FMTE9XX1NJR05BTF9XUklURVN9IGZyb20gJ0B0YWlnYS11aS9jZGsvY29uc3RhbnRzJztcblxudHlwZSBXaXRoVmFsdWUgPSBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTFNlbGVjdEVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50O1xuXG5leHBvcnQgZnVuY3Rpb24gdHVpVmFsdWUoXG4gICAgaW5wdXQ6XG4gICAgICAgIHwgRWxlbWVudFJlZjxXaXRoVmFsdWU+XG4gICAgICAgIHwgU2lnbmFsPEVsZW1lbnRSZWY8V2l0aFZhbHVlPiB8IHVuZGVmaW5lZD5cbiAgICAgICAgfCBTaWduYWw8V2l0aFZhbHVlIHwgdW5kZWZpbmVkPlxuICAgICAgICB8IFdpdGhWYWx1ZSxcbiAgICBpbmplY3RvciA9IGluamVjdChJTkpFQ1RPUiksXG4pOiBXcml0YWJsZVNpZ25hbDxzdHJpbmc+IHtcbiAgICBjb25zdCB3aW4gPSBpbmplY3Rvci5nZXQ8YW55PihXQV9XSU5ET1cpO1xuXG4gICAgaWYgKCF3aW4udHVpSW5wdXRQYXRjaGVkICYmIGlzUGxhdGZvcm1Ccm93c2VyKGluamVjdG9yLmdldChQTEFURk9STV9JRCkpKSB7XG4gICAgICAgIHdpbi50dWlJbnB1dFBhdGNoZWQgPSB0cnVlO1xuXG4gICAgICAgIHBhdGNoKHdpbi5IVE1MSW5wdXRFbGVtZW50LnByb3RvdHlwZSk7XG4gICAgICAgIHBhdGNoKHdpbi5IVE1MVGV4dEFyZWFFbGVtZW50LnByb3RvdHlwZSk7XG4gICAgICAgIHBhdGNoKHdpbi5IVE1MU2VsZWN0RWxlbWVudC5wcm90b3R5cGUpO1xuICAgIH1cblxuICAgIGxldCBlbGVtZW50ID0gaXNTaWduYWwoaW5wdXQpID8gdW5kZWZpbmVkIDogY29lcmNlRWxlbWVudChpbnB1dCk7XG4gICAgbGV0IGNsZWFudXAgPSAoKTogdm9pZCA9PiB7fTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7aW5qZWN0b3IsIC4uLlRVSV9BTExPV19TSUdOQUxfV1JJVEVTfTtcbiAgICBjb25zdCB2YWx1ZSA9IHNpZ25hbChlbGVtZW50Py52YWx1ZSB8fCAnJyk7XG4gICAgY29uc3QgcHJvY2VzcyA9IChlbDogV2l0aFZhbHVlKTogKCgpID0+IHZvaWQpID0+IHtcbiAgICAgICAgY29uc3QgdXBkYXRlID0gKCk6IHZvaWQgPT4gdmFsdWUuc2V0KGVsLnZhbHVlKTtcblxuICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIHVwZGF0ZSk7XG4gICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3R1aS1pbnB1dCcsIHVwZGF0ZSk7XG5cbiAgICAgICAgcmV0dXJuICgpOiB2b2lkID0+IHtcbiAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdXBkYXRlKTtcbiAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3R1aS1pbnB1dCcsIHVwZGF0ZSk7XG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIGluamVjdG9yLmdldChEZXN0cm95UmVmKS5vbkRlc3Ryb3koKCkgPT4gY2xlYW51cCgpKTtcblxuICAgIGlmIChpc1NpZ25hbChpbnB1dCkpIHtcbiAgICAgICAgZWZmZWN0KCgpID0+IHtcbiAgICAgICAgICAgIGVsZW1lbnQgPSBjb2VyY2VFbGVtZW50KGlucHV0KCkpO1xuICAgICAgICAgICAgY2xlYW51cCgpO1xuXG4gICAgICAgICAgICBpZiAoZWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHZhbHVlLnNldChlbGVtZW50LnZhbHVlKTtcbiAgICAgICAgICAgICAgICBjbGVhbnVwID0gcHJvY2VzcyhlbGVtZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgb3B0aW9ucyk7XG4gICAgfSBlbHNlIGlmIChlbGVtZW50KSB7XG4gICAgICAgIGNsZWFudXAgPSBwcm9jZXNzKGVsZW1lbnQpO1xuICAgIH1cblxuICAgIGVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IHYgPSB2YWx1ZSgpO1xuXG4gICAgICAgIGlmIChlbGVtZW50Py5tYXRjaGVzKCc6Zm9jdXMnKSAmJiAnc2VsZWN0aW9uU3RhcnQnIGluIGVsZW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IHtzZWxlY3Rpb25TdGFydCwgc2VsZWN0aW9uRW5kfSA9IGVsZW1lbnQ7XG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogQWZ0ZXIgcHJvZ3JhbW1hdGljIHVwZGF0ZXMgb2YgaW5wdXQncyB2YWx1ZSwgY2FyZXQgaXMgYXV0b21hdGljYWxseSBwbGFjZWQgYXQgdGhlIGVuZCDigJNcbiAgICAgICAgICAgICAqIHJldmVydCB0byB0aGUgcHJldmlvdXMgcG9zaXRpb25cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9IHY7XG4gICAgICAgICAgICBlbGVtZW50LnNldFNlbGVjdGlvblJhbmdlKHNlbGVjdGlvblN0YXJ0LCBzZWxlY3Rpb25FbmQpO1xuICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSB2O1xuICAgICAgICB9XG4gICAgfSwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gdmFsdWU7XG59XG5cbmZ1bmN0aW9uIHBhdGNoKHByb3RvdHlwZTogV2l0aFZhbHVlKTogdm9pZCB7XG4gICAgY29uc3Qge3NldH0gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvdHlwZSwgJ3ZhbHVlJykhO1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvdHlwZSwgJ3ZhbHVlJywge1xuICAgICAgICBzZXQodGhpczogV2l0aFZhbHVlLCBkZXRhaWw6IHN0cmluZykge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLnZhbHVlO1xuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBuZXcgQ3VzdG9tRXZlbnQoJ3R1aS1pbnB1dCcsIHtkZXRhaWwsIGJ1YmJsZXM6IHRydWV9KTtcblxuICAgICAgICAgICAgc2V0IS5jYWxsKHRoaXMsIGRldGFpbCk7XG5cbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gZGV0YWlsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICB9KTtcbn1cbiJdfQ==