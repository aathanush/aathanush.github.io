import { ChangeDetectionStrategy, Component, computed, Directive, effect, inject, ViewEncapsulation, } from '@angular/core';
import { TUI_IDENTITY_VALUE_TRANSFORMER, TuiNonNullableValueTransformer, TuiValueTransformer, } from '@taiga-ui/cdk/classes';
import { TUI_ALLOW_SIGNAL_WRITES } from '@taiga-ui/cdk/constants';
import { TUI_IS_MOBILE } from '@taiga-ui/cdk/tokens';
import { tuiInjectElement, tuiIsElement, tuiIsInput } from '@taiga-ui/cdk/utils/dom';
import { tuiClamp } from '@taiga-ui/cdk/utils/math';
import { tuiWithStyles } from '@taiga-ui/cdk/utils/miscellaneous';
import { tuiInjectAuxiliary } from '@taiga-ui/core/components/textfield';
import { TuiInputNumberDirective, tuiInputNumberOptionsProvider, } from '@taiga-ui/kit/components/input-number';
import { TuiSliderComponent } from '@taiga-ui/kit/components/slider';
import { filter, fromEvent } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@taiga-ui/kit/components/input-number";
class TuiInputSliderDirective {
    constructor() {
        this.isMobile = inject(TUI_IS_MOBILE);
        this.element = tuiInjectElement();
        this.inputNumber = inject(TuiInputNumberDirective, { self: true });
        this.slider = tuiInjectAuxiliary((x) => x instanceof TuiSliderComponent);
        this.controlTransformer = inject(TuiValueTransformer, { self: true });
        this.value = computed(() => this.controlTransformer.toControlValue(this.inputNumber.value()));
        this.keyStepsTransformer = computed(() => this.slider()?.keySteps?.transformer() ?? TUI_IDENTITY_VALUE_TRANSFORMER);
        this.nothing = tuiWithStyles(TuiInputSliderStyles);
        this.textfieldToSliderSync = effect(() => {
            const slider = this.slider();
            if (!slider) {
                return;
            }
            if (slider.keySteps && Number.isFinite(slider.keySteps?.totalSteps)) {
                // TODO(v5): move all if-condition body inside `TuiSliderKeyStepsBase`
                slider.min = 0;
                slider.step = 1;
                slider.max = slider.keySteps?.totalSteps ?? 100;
            }
            else {
                slider.min = this.inputNumber.min();
                slider.max = this.inputNumber.max();
            }
            slider.value = this.keyStepsTransformer().fromControlValue(this.value());
            slider.el.disabled = !this.inputNumber.interactive();
        }, TUI_ALLOW_SIGNAL_WRITES);
        this.sliderInitEffect = effect((onCleanup) => {
            const slider = this.slider();
            if (!slider) {
                return;
            }
            slider.el.style.setProperty('--tui-slider-track-color', 'transparent');
            if (slider.keySteps) {
                slider.keySteps.value = this.value;
            }
            const subscription = fromEvent(slider.el, 'input', (x) => x.target)
                .pipe(filter(tuiIsElement), filter(tuiIsInput))
                .subscribe((x) => this.onSliderInput(x.valueAsNumber));
            onCleanup(() => subscription.unsubscribe());
        });
    }
    onStep(coefficient) {
        const slider = this.slider();
        if (slider && this.inputNumber.interactive()) {
            const newValue = tuiClamp(slider.keySteps?.takeStep(coefficient) ??
                slider.value + coefficient * slider.step, this.inputNumber.min(), this.inputNumber.max());
            this.inputNumber.setValue(newValue);
        }
    }
    onBlur() {
        if (!this.element.value) {
            this.inputNumber.setValue(this.value() ?? null);
        }
    }
    onSliderInput(value) {
        this.inputNumber.setValue(this.keyStepsTransformer().toControlValue(value));
        if (!this.isMobile) {
            this.element.focus();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiInputSliderDirective, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.2.12", type: TuiInputSliderDirective, isStandalone: true, selector: "input[tuiInputSlider]", host: { listeners: { "blur": "onBlur()", "keydown.arrowUp": "onStep(1)", "keydown.arrowDown": "onStep(-1)" } }, providers: [
            tuiInputNumberOptionsProvider({
                valueTransformer: new TuiNonNullableValueTransformer(),
            }),
        ], hostDirectives: [{ directive: i1.TuiInputNumberDirective, inputs: ["min", "min", "max", "max", "prefix", "prefix", "postfix", "postfix", "invalid", "invalid", "readOnly", "readOnly"] }], ngImport: i0 }); }
}
export { TuiInputSliderDirective };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiInputSliderDirective, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: 'input[tuiInputSlider]',
                    providers: [
                        tuiInputNumberOptionsProvider({
                            valueTransformer: new TuiNonNullableValueTransformer(),
                        }),
                    ],
                    hostDirectives: [
                        {
                            directive: TuiInputNumberDirective,
                            inputs: ['min', 'max', 'prefix', 'postfix', 'invalid', 'readOnly'],
                        },
                    ],
                    host: {
                        '(blur)': 'onBlur()',
                        '(keydown.arrowUp)': 'onStep(1)',
                        '(keydown.arrowDown)': 'onStep(-1)',
                    },
                }]
        }] });
class TuiInputSliderStyles {
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiInputSliderStyles, deps: [], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TuiInputSliderStyles, isStandalone: true, selector: "ng-component", host: { classAttribute: "tui-input-slider" }, ngImport: i0, template: '', isInline: true, styles: ["tui-textfield [tuiInputSlider]~.t-content .t-clear{display:none!important}\n"], changeDetection: i0.ChangeDetectionStrategy.OnPush, encapsulation: i0.ViewEncapsulation.None }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TuiInputSliderStyles, decorators: [{
            type: Component,
            args: [{ standalone: true, template: '', encapsulation: ViewEncapsulation.None, changeDetection: ChangeDetectionStrategy.OnPush, host: {
                        class: 'tui-input-slider',
                    }, styles: ["tui-textfield [tuiInputSlider]~.t-content .t-clear{display:none!important}\n"] }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXQtc2xpZGVyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2tpdC9jb21wb25lbnRzL2lucHV0LXNsaWRlci9pbnB1dC1zbGlkZXIuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFFBQVEsRUFDUixTQUFTLEVBQ1QsTUFBTSxFQUNOLE1BQU0sRUFDTixpQkFBaUIsR0FDcEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNILDhCQUE4QixFQUM5Qiw4QkFBOEIsRUFDOUIsbUJBQW1CLEdBQ3RCLE1BQU0sdUJBQXVCLENBQUM7QUFDL0IsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDaEUsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDbkYsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQ2xELE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxtQ0FBbUMsQ0FBQztBQUNoRSxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUN2RSxPQUFPLEVBQ0gsdUJBQXVCLEVBQ3ZCLDZCQUE2QixHQUNoQyxNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGlDQUFpQyxDQUFDO0FBQ25FLE9BQU8sRUFBQyxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sTUFBTSxDQUFDOzs7QUFFdkMsTUFvQmEsdUJBQXVCO0lBcEJwQztRQXFCcUIsYUFBUSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNqQyxZQUFPLEdBQUcsZ0JBQWdCLEVBQW9CLENBQUM7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LEVBQUU7YUFDekQsQ0FBQztTQUNMOztTQWFRLHVCQUF1Qjs0RkFBdkIsdUJBQXVCO2tCQXBCbkMsU0FBUzttQkFBQztvQkFDUCxVQUFVLEVBQUUsSUFBSTtvQkFDaEIsUUFBUSxFQUFFLHVCQUF1QjtvQkFDakMsU0FBUyxFQUFFO3dCQUNQLDZCQUE2QixDQUFDOzRCQUMxQixnQkFBZ0IsRUFBRSxJQUFJLDhCQUE4QixFQUFFO3lCQUN6RCxDQUFDO3FCQUNMO29CQUNELGNBQWMsRUFBRTt3QkFDWjs0QkFDSSxTQUFTLEVBQUUsdUJBQXVCOzRCQUNsQyxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQzt5QkFDckU7cUJBQ0o7b0JBQ0QsSUFBSSxFQUFFO3dCQUNGLFFBQVEsRUFBRSxVQUFVO3dCQUNwQixtQkFBbUIsRUFBRSxXQUFXO3dCQUNoQyxxQkFBcUIsRUFBRSxZQUFZO3FCQUN0QztpQkFDSjs7QUE4RkQsTUFhTSxvQkFBb0I7K0dBQXBCLG9CQUFvQjttR0FBcEIsb0JBQW9CLHNIQVhaLEVBQUU7OzRGQVdWLG9CQUFvQjtrQkFiekIsU0FBUztpQ0FDTSxJQUFJLFlBQ04sRUFBRSxpQkFLRyxpQkFBaUIsQ0FBQyxJQUFJLG1CQUNwQix1QkFBdUIsQ0FBQyxNQUFNLFFBQ3pDO3dCQUNGLEtBQUssRUFBRSxrQkFBa0I7cUJBQzVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgICBDb21wb25lbnQsXG4gICAgY29tcHV0ZWQsXG4gICAgRGlyZWN0aXZlLFxuICAgIGVmZmVjdCxcbiAgICBpbmplY3QsXG4gICAgVmlld0VuY2Fwc3VsYXRpb24sXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBUVUlfSURFTlRJVFlfVkFMVUVfVFJBTlNGT1JNRVIsXG4gICAgVHVpTm9uTnVsbGFibGVWYWx1ZVRyYW5zZm9ybWVyLFxuICAgIFR1aVZhbHVlVHJhbnNmb3JtZXIsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsvY2xhc3Nlcyc7XG5pbXBvcnQge1RVSV9BTExPV19TSUdOQUxfV1JJVEVTfSBmcm9tICdAdGFpZ2EtdWkvY2RrL2NvbnN0YW50cyc7XG5pbXBvcnQge1RVSV9JU19NT0JJTEV9IGZyb20gJ0B0YWlnYS11aS9jZGsvdG9rZW5zJztcbmltcG9ydCB7dHVpSW5qZWN0RWxlbWVudCwgdHVpSXNFbGVtZW50LCB0dWlJc0lucHV0fSBmcm9tICdAdGFpZ2EtdWkvY2RrL3V0aWxzL2RvbSc7XG5pbXBvcnQge3R1aUNsYW1wfSBmcm9tICdAdGFpZ2EtdWkvY2RrL3V0aWxzL21hdGgnO1xuaW1wb3J0IHt0dWlXaXRoU3R5bGVzfSBmcm9tICdAdGFpZ2EtdWkvY2RrL3V0aWxzL21pc2NlbGxhbmVvdXMnO1xuaW1wb3J0IHt0dWlJbmplY3RBdXhpbGlhcnl9IGZyb20gJ0B0YWlnYS11aS9jb3JlL2NvbXBvbmVudHMvdGV4dGZpZWxkJztcbmltcG9ydCB7XG4gICAgVHVpSW5wdXROdW1iZXJEaXJlY3RpdmUsXG4gICAgdHVpSW5wdXROdW1iZXJPcHRpb25zUHJvdmlkZXIsXG59IGZyb20gJ0B0YWlnYS11aS9raXQvY29tcG9uZW50cy9pbnB1dC1udW1iZXInO1xuaW1wb3J0IHtUdWlTbGlkZXJDb21wb25lbnR9IGZyb20gJ0B0YWlnYS11aS9raXQvY29tcG9uZW50cy9zbGlkZXInO1xuaW1wb3J0IHtmaWx0ZXIsIGZyb21FdmVudH0gZnJvbSAncnhqcyc7XG5cbkBEaXJlY3RpdmUoe1xuICAgIHN0YW5kYWxvbmU6IHRydWUsXG4gICAgc2VsZWN0b3I6ICdpbnB1dFt0dWlJbnB1dFNsaWRlcl0nLFxuICAgIHByb3ZpZGVyczogW1xuICAgICAgICB0dWlJbnB1dE51bWJlck9wdGlvbnNQcm92aWRlcih7XG4gICAgICAgICAgICB2YWx1ZVRyYW5zZm9ybWVyOiBuZXcgVHVpTm9uTnVsbGFibGVWYWx1ZVRyYW5zZm9ybWVyKCksXG4gICAgICAgIH0pLFxuICAgIF0sXG4gICAgaG9zdERpcmVjdGl2ZXM6IFtcbiAgICAgICAge1xuICAgICAgICAgICAgZGlyZWN0aXZlOiBUdWlJbnB1dE51bWJlckRpcmVjdGl2ZSxcbiAgICAgICAgICAgIGlucHV0czogWydtaW4nLCAnbWF4JywgJ3ByZWZpeCcsICdwb3N0Zml4JywgJ2ludmFsaWQnLCAncmVhZE9ubHknXSxcbiAgICAgICAgfSxcbiAgICBdLFxuICAgIGhvc3Q6IHtcbiAgICAgICAgJyhibHVyKSc6ICdvbkJsdXIoKScsXG4gICAgICAgICcoa2V5ZG93bi5hcnJvd1VwKSc6ICdvblN0ZXAoMSknLFxuICAgICAgICAnKGtleWRvd24uYXJyb3dEb3duKSc6ICdvblN0ZXAoLTEpJyxcbiAgICB9LFxufSlcbmV4cG9ydCBjbGFzcyBUdWlJbnB1dFNsaWRlckRpcmVjdGl2ZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBpc01vYmlsZSA9IGluamVjdChUVUlfSVNfTU9CSUxFKTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnQgPSB0dWlJbmplY3RFbGVtZW50PEhUTUxJbnB1dEVsZW1lbnQ+KCk7XG4gICAgcHJpdmF0ZSByZWFkb25seSBpbnB1dE51bWJlciA9IGluamVjdChUdWlJbnB1dE51bWJlckRpcmVjdGl2ZSwge3NlbGY6IHRydWV9KTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNsaWRlciA9IHR1aUluamVjdEF1eGlsaWFyeTxUdWlTbGlkZXJDb21wb25lbnQ+KFxuICAgICAgICAoeCkgPT4geCBpbnN0YW5jZW9mIFR1aVNsaWRlckNvbXBvbmVudCxcbiAgICApO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb250cm9sVHJhbnNmb3JtZXIgPSBpbmplY3Q8XG4gICAgICAgIFR1aVZhbHVlVHJhbnNmb3JtZXI8bnVtYmVyIHwgbnVsbCwgbnVtYmVyPlxuICAgID4oVHVpVmFsdWVUcmFuc2Zvcm1lciwge3NlbGY6IHRydWV9KTtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgdmFsdWUgPSBjb21wdXRlZCgoKSA9PlxuICAgICAgICB0aGlzLmNvbnRyb2xUcmFuc2Zvcm1lci50b0NvbnRyb2xWYWx1ZSh0aGlzLmlucHV0TnVtYmVyLnZhbHVlKCkpLFxuICAgICk7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGtleVN0ZXBzVHJhbnNmb3JtZXIgPSBjb21wdXRlZChcbiAgICAgICAgKCkgPT4gdGhpcy5zbGlkZXIoKT8ua2V5U3RlcHM/LnRyYW5zZm9ybWVyKCkgPz8gVFVJX0lERU5USVRZX1ZBTFVFX1RSQU5TRk9STUVSLFxuICAgICk7XG5cbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgbm90aGluZyA9IHR1aVdpdGhTdHlsZXMoVHVpSW5wdXRTbGlkZXJTdHlsZXMpO1xuXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IHRleHRmaWVsZFRvU2xpZGVyU3luYyA9IGVmZmVjdCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IHNsaWRlciA9IHRoaXMuc2xpZGVyKCk7XG5cbiAgICAgICAgaWYgKCFzbGlkZXIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzbGlkZXIua2V5U3RlcHMgJiYgTnVtYmVyLmlzRmluaXRlKHNsaWRlci5rZXlTdGVwcz8udG90YWxTdGVwcykpIHtcbiAgICAgICAgICAgIC8vIFRPRE8odjUpOiBtb3ZlIGFsbCBpZi1jb25kaXRpb24gYm9keSBpbnNpZGUgYFR1aVNsaWRlcktleVN0ZXBzQmFzZWBcbiAgICAgICAgICAgIHNsaWRlci5taW4gPSAwO1xuICAgICAgICAgICAgc2xpZGVyLnN0ZXAgPSAxO1xuICAgICAgICAgICAgc2xpZGVyLm1heCA9IHNsaWRlci5rZXlTdGVwcz8udG90YWxTdGVwcyA/PyAxMDA7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzbGlkZXIubWluID0gdGhpcy5pbnB1dE51bWJlci5taW4oKTtcbiAgICAgICAgICAgIHNsaWRlci5tYXggPSB0aGlzLmlucHV0TnVtYmVyLm1heCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgc2xpZGVyLnZhbHVlID0gdGhpcy5rZXlTdGVwc1RyYW5zZm9ybWVyKCkuZnJvbUNvbnRyb2xWYWx1ZSh0aGlzLnZhbHVlKCkpO1xuICAgICAgICBzbGlkZXIuZWwuZGlzYWJsZWQgPSAhdGhpcy5pbnB1dE51bWJlci5pbnRlcmFjdGl2ZSgpO1xuICAgIH0sIFRVSV9BTExPV19TSUdOQUxfV1JJVEVTKTtcblxuICAgIHByb3RlY3RlZCByZWFkb25seSBzbGlkZXJJbml0RWZmZWN0ID0gZWZmZWN0KChvbkNsZWFudXApID0+IHtcbiAgICAgICAgY29uc3Qgc2xpZGVyID0gdGhpcy5zbGlkZXIoKTtcblxuICAgICAgICBpZiAoIXNsaWRlcikge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgc2xpZGVyLmVsLnN0eWxlLnNldFByb3BlcnR5KCctLXR1aS1zbGlkZXItdHJhY2stY29sb3InLCAndHJhbnNwYXJlbnQnKTtcblxuICAgICAgICBpZiAoc2xpZGVyLmtleVN0ZXBzKSB7XG4gICAgICAgICAgICBzbGlkZXIua2V5U3RlcHMudmFsdWUgPSB0aGlzLnZhbHVlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gZnJvbUV2ZW50KHNsaWRlci5lbCwgJ2lucHV0JywgKHgpID0+IHgudGFyZ2V0KVxuICAgICAgICAgICAgLnBpcGUoZmlsdGVyKHR1aUlzRWxlbWVudCksIGZpbHRlcih0dWlJc0lucHV0KSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHgpID0+IHRoaXMub25TbGlkZXJJbnB1dCh4LnZhbHVlQXNOdW1iZXIpKTtcblxuICAgICAgICBvbkNsZWFudXAoKCkgPT4gc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCkpO1xuICAgIH0pO1xuXG4gICAgcHJvdGVjdGVkIG9uU3RlcChjb2VmZmljaWVudDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHNsaWRlciA9IHRoaXMuc2xpZGVyKCk7XG5cbiAgICAgICAgaWYgKHNsaWRlciAmJiB0aGlzLmlucHV0TnVtYmVyLmludGVyYWN0aXZlKCkpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdHVpQ2xhbXAoXG4gICAgICAgICAgICAgICAgc2xpZGVyLmtleVN0ZXBzPy50YWtlU3RlcChjb2VmZmljaWVudCkgPz9cbiAgICAgICAgICAgICAgICAgICAgc2xpZGVyLnZhbHVlICsgY29lZmZpY2llbnQgKiBzbGlkZXIuc3RlcCxcbiAgICAgICAgICAgICAgICB0aGlzLmlucHV0TnVtYmVyLm1pbigpLFxuICAgICAgICAgICAgICAgIHRoaXMuaW5wdXROdW1iZXIubWF4KCksXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICB0aGlzLmlucHV0TnVtYmVyLnNldFZhbHVlKG5ld1ZhbHVlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBvbkJsdXIoKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5lbGVtZW50LnZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmlucHV0TnVtYmVyLnNldFZhbHVlKHRoaXMudmFsdWUoKSA/PyBudWxsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgb25TbGlkZXJJbnB1dCh2YWx1ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaW5wdXROdW1iZXIuc2V0VmFsdWUodGhpcy5rZXlTdGVwc1RyYW5zZm9ybWVyKCkudG9Db250cm9sVmFsdWUodmFsdWUpKTtcblxuICAgICAgICBpZiAoIXRoaXMuaXNNb2JpbGUpIHtcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5mb2N1cygpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5AQ29tcG9uZW50KHtcbiAgICBzdGFuZGFsb25lOiB0cnVlLFxuICAgIHRlbXBsYXRlOiAnJyxcbiAgICBzdHlsZXM6IFtcbiAgICAgICAgLy8gVE9ETzogdHVpLXRleHRmaWVsZDpoYXMoW3R1aUlucHV0U2xpZGVyXSkgLnQtY2xlYXJcbiAgICAgICAgJ3R1aS10ZXh0ZmllbGQgW3R1aUlucHV0U2xpZGVyXSB+IC50LWNvbnRlbnQgLnQtY2xlYXIge2Rpc3BsYXk6IG5vbmUgIWltcG9ydGFudH0nLFxuICAgIF0sXG4gICAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgICBob3N0OiB7XG4gICAgICAgIGNsYXNzOiAndHVpLWlucHV0LXNsaWRlcicsXG4gICAgfSxcbn0pXG5jbGFzcyBUdWlJbnB1dFNsaWRlclN0eWxlcyB7fVxuIl19