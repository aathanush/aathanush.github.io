import { ChangeDetectorRef, Directive, inject, INJECTOR, Input, TemplateRef, ViewContainerRef, } from '@angular/core';
import { PolymorpheusComponent } from '../classes/component';
import { PolymorpheusContext } from '../classes/context';
import { isPrimitive } from '../utils/is-primitive';
import { PolymorpheusTemplate } from './template';
import * as i0 from "@angular/core";
class PolymorpheusOutlet {
    constructor() {
        this.vcr = inject(ViewContainerRef);
        this.i = inject(INJECTOR);
        this.t = inject(TemplateRef);
        this.content = '';
    }
    static ngTemplateContextGuard(_dir, _ctx) {
        return true;
    }
    ngOnChanges({ content }) {
        const context = this.getContext();
        this.c?.injector.get(ChangeDetectorRef).markForCheck();
        if (!content) {
            return;
        }
        this.vcr.clear();
        const proxy = context &&
            new Proxy(ensureContext(context), {
                get: (_, key) => ensureContext(this.getContext())?.[key],
            });
        if (isComponent(this.content)) {
            this.process(this.content, proxy);
        }
        else if ((context instanceof PolymorpheusContext && context.$implicit) != null) {
            this.vcr.createEmbeddedView(this.template, proxy, { injector: this.i });
        }
    }
    ngDoCheck() {
        if (isDirective(this.content)) {
            this.content.check();
        }
    }
    get template() {
        if (isDirective(this.content)) {
            return this.content.template;
        }
        return this.content instanceof TemplateRef ? this.content : this.t;
    }
    getContext() {
        if (isTemplate(this.content) || isComponent(this.content)) {
            return this.context;
        }
        return new PolymorpheusContext(typeof this.content === 'function'
            ? this.content(this.context ?? {})
            : this.content);
    }
    process(content, proxy) {
        const injector = content.createInjector(this.i, proxy);
        this.c = this.vcr.createComponent(content.component, { injector });
    }
    /** @nocollapse */ static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: PolymorpheusOutlet, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    /** @nocollapse */ static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.2.12", type: PolymorpheusOutlet, isStandalone: true, selector: "[polymorpheusOutlet]", inputs: { content: ["polymorpheusOutlet", "content"], context: ["polymorpheusOutletContext", "context"] }, usesOnChanges: true, ngImport: i0 }); }
}
export { PolymorpheusOutlet };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: PolymorpheusOutlet, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: '[polymorpheusOutlet]',
                }]
        }], propDecorators: { content: [{
                type: Input,
                args: ['polymorpheusOutlet']
            }], context: [{
                type: Input,
                args: ['polymorpheusOutletContext']
            }] } });
function isDirective(content) {
    return content instanceof PolymorpheusTemplate;
}
function isComponent(content) {
    return content instanceof PolymorpheusComponent;
}
function isTemplate(content) {
    return isDirective(content) || content instanceof TemplateRef;
}
function ensureContext(context) {
    if (context && isPrimitive(context)) {
        return new PolymorpheusContext(context);
    }
    return context;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctcG9seW1vcnBoZXVzL3NyYy9kaXJlY3RpdmVzL291dGxldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0gsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxNQUFNLEVBQ04sUUFBUSxFQUNSLEtBQUssRUFDTCxXQUFXLEVBQ1gsZ0JBQWdCLEdBQ25CLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzNELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBR3ZELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUNsRCxPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxZQUFZLENBQUM7O0FBRWhELE1BSWEsa0JBQWtCO0lBSi9CO1FBS3FCLFFBQUcsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMvQixNQUFDLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JCLE1BQUMsR0FDZCxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7UUFLakIsWUFBTyxHQUEyQixFQUFFLENBQUM7S0F3RS9DO0lBbkVVLE1BQU0sQ0FBQyxzQkFBc0IsQ0FDaEMsSUFBMkIsRUFDM0IsSUFBUztRQUVULE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFTSxXQUFXLENBQUMsRUFBQyxPQUFPLEVBQWdCO1FBQ3ZDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUVsQyxJQUFJLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUV2RCxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1YsT0FBTztTQUNWO1FBRUQsSUFBSSxDQUFD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QUFZLFdBQVcsQ0FBQztBQUNsRSxDQUFDO0FBRUQsU0FBUyxhQUFhLENBQ2xCLE9BQWlEO0lBRWpELElBQUksT0FBTyxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUNqQyxPQUFPLElBQUksbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDM0M7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUge0NvbXBvbmVudFJlZiwgRG9DaGVjaywgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgRGlyZWN0aXZlLFxuICAgIGluamVjdCxcbiAgICBJTkpFQ1RPUixcbiAgICBJbnB1dCxcbiAgICBUZW1wbGF0ZVJlZixcbiAgICBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtQb2x5bW9ycGhldXNDb21wb25lbnR9IGZyb20gJy4uL2NsYXNzZXMvY29tcG9uZW50JztcbmltcG9ydCB7UG9seW1vcnBoZXVzQ29udGV4dH0gZnJvbSAnLi4vY2xhc3Nlcy9jb250ZXh0JztcbmltcG9ydCB0eXBlIHtQb2x5bW9ycGhldXNDb250ZW50fSBmcm9tICcuLi90eXBlcy9jb250ZW50JztcbmltcG9ydCB0eXBlIHtQb2x5bW9ycGhldXNQcmltaXRpdmV9IGZyb20gJy4uL3R5cGVzL3ByaW1pdGl2ZSc7XG5pbXBvcnQge2lzUHJpbWl0aXZlfSBmcm9tICcuLi91dGlscy9pcy1wcmltaXRpdmUnO1xuaW1wb3J0IHtQb2x5bW9ycGhldXNUZW1wbGF0ZX0gZnJvbSAnLi90ZW1wbGF0ZSc7XG5cbkBEaXJlY3RpdmUoe1xuICAgIHN0YW5kYWxvbmU6IHRydWUsXG4gICAgc2VsZWN0b3I6ICdbcG9seW1vcnBoZXVzT3V0bGV0XScsXG59KVxuZXhwb3J0IGNsYXNzIFBvbHltb3JwaGV1c091dGxldDxDPiBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgRG9DaGVjayB7XG4gICAgcHJpdmF0ZSByZWFkb25seSB2Y3IgPSBpbmplY3QoVmlld0NvbnRhaW5lclJlZik7XG4gICAgcHJpdmF0ZSByZWFkb25seSBpID0gaW5qZWN0KElOSkVDVE9SKTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHQ6IFRlbXBsYXRlUmVmPFBvbHltb3JwaGV1c0NvbnRleHQ8UG9seW1vcnBoZXVzUHJpbWl0aXZlPj4gPVxuICAgICAgICBpbmplY3QoVGVtcGxhdGVSZWYpO1xuXG4gICAgcHJpdmF0ZSBjPzogQ29tcG9uZW50UmVmPHVua25vd24+O1xuXG4gICAgQElucHV0KCdwb2x5bW9ycGhldXNPdXRsZXQnKVxuICAgIHB1YmxpYyBjb250ZW50OiBQb2x5bW9ycGhldXNDb250ZW50PEM+ID0gJyc7XG5cbiAgICBASW5wdXQoJ3BvbHltb3JwaGV1c091dGxldENvbnRleHQnKVxuICAgIHB1YmxpYyBjb250ZXh0PzogQztcblxuICAgIHB1YmxpYyBzdGF0aWMgbmdUZW1wbGF0ZUNvbnRleHRHdWFyZDxUPihcbiAgICAgICAgX2RpcjogUG9seW1vcnBoZXVzT3V0bGV0PFQ+LFxuICAgICAgICBfY3R4OiBhbnksXG4gICAgKTogX2N0eCBpcyBQb2x5bW9ycGhldXNDb250ZXh0PFQgZXh0ZW5kcyBQb2x5bW9ycGhldXNQcmltaXRpdmUgPyBUIDogbmV2ZXI+IHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHVibGljIG5nT25DaGFuZ2VzKHtjb250ZW50fTogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgICAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5nZXRDb250ZXh0KCk7XG5cbiAgICAgICAgdGhpcy5jPy5pbmplY3Rvci5nZXQoQ2hhbmdlRGV0ZWN0b3JSZWYpLm1hcmtGb3JDaGVjaygpO1xuXG4gICAgICAgIGlmICghY29udGVudCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy52Y3IuY2xlYXIoKTtcblxuICAgICAgICBjb25zdCBwcm94eSA9XG4gICAgICAgICAgICBjb250ZXh0ICYmXG4gICAgICAgICAgICAobmV3IFByb3h5KGVuc3VyZUNvbnRleHQoY29udGV4dCkgYXMgb2JqZWN0LCB7XG4gICAgICAgICAgICAgICAgZ2V0OiAoXywga2V5KSA9PlxuICAgICAgICAgICAgICAgICAgICBlbnN1cmVDb250ZXh0KHRoaXMuZ2V0Q29udGV4dCgpKT8uW1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5IGFzIGtleW9mIChDIHwgUG9seW1vcnBoZXVzQ29udGV4dDxhbnk+KVxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSkgYXMgdW5rbm93biBhcyBDKTtcblxuICAgICAgICBpZiAoaXNDb21wb25lbnQodGhpcy5jb250ZW50KSkge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzKHRoaXMuY29udGVudCwgcHJveHkpO1xuICAgICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAgICAgKGNvbnRleHQgaW5zdGFuY2VvZiBQb2x5bW9ycGhldXNDb250ZXh0ICYmIGNvbnRleHQuJGltcGxpY2l0KSAhPSBudWxsXG4gICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy52Y3IuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMudGVtcGxhdGUsIHByb3h5LCB7aW5qZWN0b3I6IHRoaXMuaX0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG5nRG9DaGVjaygpOiB2b2lkIHtcbiAgICAgICAgaWYgKGlzRGlyZWN0aXZlKHRoaXMuY29udGVudCkpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGVudC5jaGVjaygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgdGVtcGxhdGUoKTogVGVtcGxhdGVSZWY8dW5rbm93bj4ge1xuICAgICAgICBpZiAoaXNEaXJlY3RpdmUodGhpcy5jb250ZW50KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudC50ZW1wbGF0ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmNvbnRlbnQgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZiA/IHRoaXMuY29udGVudCA6IHRoaXMudDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENvbnRleHQoKTogQyB8IFBvbHltb3JwaGV1c0NvbnRleHQ8YW55PiB8IHVuZGVmaW5lZCB7XG4gICAgICAgIGlmIChpc1RlbXBsYXRlKHRoaXMuY29udGVudCkgfHwgaXNDb21wb25lbnQodGhpcy5jb250ZW50KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29udGV4dDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBuZXcgUG9seW1vcnBoZXVzQ29udGV4dChcbiAgICAgICAgICAgIHR5cGVvZiB0aGlzLmNvbnRlbnQgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgICAgICA/IHRoaXMuY29udGVudCh0aGlzLmNvbnRleHQgPz8gKHt9IGFzIGFueSkpXG4gICAgICAgICAgICAgICAgOiB0aGlzLmNvbnRlbnQsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzKGNvbnRlbnQ6IFBvbHltb3JwaGV1c0NvbXBvbmVudDx1bmtub3duPiwgcHJveHk/OiBDKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGluamVjdG9yID0gY29udGVudC5jcmVhdGVJbmplY3Rvcih0aGlzLmksIHByb3h5KTtcblxuICAgICAgICB0aGlzLmMgPSB0aGlzLnZjci5jcmVhdGVDb21wb25lbnQoY29udGVudC5jb21wb25lbnQsIHtpbmplY3Rvcn0pO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaXNEaXJlY3RpdmU8Qz4oXG4gICAgY29udGVudDogUG9seW1vcnBoZXVzQ29udGVudDxDPixcbik6IGNvbnRlbnQgaXMgUG9seW1vcnBoZXVzVGVtcGxhdGU8Qz4ge1xuICAgIHJldHVybiBjb250ZW50IGluc3RhbmNlb2YgUG9seW1vcnBoZXVzVGVtcGxhdGU7XG59XG5cbmZ1bmN0aW9uIGlzQ29tcG9uZW50PEM+KFxuICAgIGNvbnRlbnQ6IFBvbHltb3JwaGV1c0NvbnRlbnQ8Qz4sXG4pOiBjb250ZW50IGlzIFBvbHltb3JwaGV1c0NvbXBvbmVudDxhbnk+IHtcbiAgICByZXR1cm4gY29udGVudCBpbnN0YW5jZW9mIFBvbHltb3JwaGV1c0NvbXBvbmVudDtcbn1cblxuZnVuY3Rpb24gaXNUZW1wbGF0ZTxDPihcbiAgICBjb250ZW50OiBQb2x5bW9ycGhldXNDb250ZW50PEM+LFxuKTogY29udGVudCBpcyBQb2x5bW9ycGhldXNUZW1wbGF0ZTxDPiB8IFRlbXBsYXRlUmVmPEM+IHtcbiAgICByZXR1cm4gaXNEaXJlY3RpdmUoY29udGVudCkgfHwgY29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmO1xufVxuXG5mdW5jdGlvbiBlbnN1cmVDb250ZXh0PEM+KFxuICAgIGNvbnRleHQ6IEMgfCBQb2x5bW9ycGhldXNDb250ZXh0PGFueT4gfCB1bmRlZmluZWQsXG4pOiBDIHwgUG9seW1vcnBoZXVzQ29udGV4dDxhbnk+IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoY29udGV4dCAmJiBpc1ByaW1pdGl2ZShjb250ZXh0KSkge1xuICAgICAgICByZXR1cm4gbmV3IFBvbHltb3JwaGV1c0NvbnRleHQoY29udGV4dCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbnRleHQ7XG59XG4iXX0=